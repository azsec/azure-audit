$rgName = "azsec-corporate-rg"
$aaName = "Automate-3536378-EUS"
$nodeName = "Cve20200601Verification"
$vms = Get-AzVm -ResourceGroupName $rgName | Where-Object { $_.OSProfile.WindowsConfiguration -ne $null }
$aaKey = (Get-AzAutomationRegistrationInfo -ResourceGroupName $rgName `
                                           -AutomationAccountName $aaName).PrimaryKey
$aaRegUrl = (Get-AzAutomationRegistrationInfo -ResourceGroupName $rgName `
                                              -AutomationAccountName $aaName).Endpoint


$vmExtensionName = "Microsoft.Powershell.DSC"
$extensionPublisher = "Microsoft.Powershell"
$settings = @{
        "configurationArguments" = @{
        "RegistrationUrl" = $aaRegUrl; 
        "NodeConfigurationName" = "$nodeName.localhost"; 
        "ConfigurationMode" = "applyAndMonitor"; 
        "RebootNodeIfNeeded" = $false;
        "ActionAfterReboot" = "continueConfiguration";
        "AllowModuleOverwrite" = $false;
        "ConfigurationModeFrequencyMins" = "15";
        "RefreshFrequencyMins" = "30"
    }
}
$protectedSettings = @{
    "configurationArguments" = @{
        "RegistrationKey" = @{
            "Username" = "null"; 
            "Password" = $aaKey
        } 
    } 
}

foreach ($vm in $vms) {
    Set-AzVMExtension -VMName $vm.Name `
                      -Location "westus"`
                      -ResourceGroupName $rgName `
                      -Name $vmExtensionName `
                      -Publisher $extensionPublisher `
                      -Type "DSC" `
                      -TypeHandlerVersion "2.8" `
                      -Settings $settings `
                      -ProtectedSettings $protectedSettings


    Update-AzVM -ResourceGroupName $rgName -VM $vm
}