$crypt32Path = "C:\Windows\System32\crypt32.dll"
$validHash = "6AE927255B0576AF136DF57210A1BA64C42A504D50867F58B7A128B4FD26A77C"
$validFileVesion = "10.0.14393.3442"
$osBuild = "14393.3443"
$osVersion = "1607"

$azImdsUri = "http://169.254.169.254/metadata/instance?api-version=2019-06-01"
$vmName = (Invoke-RestMethod -Headers @{"Metadata"="true"} -URI $azImdsUri -Method get).compute.name
$rgName = (Invoke-RestMethod -Headers @{"Metadata"="true"} -URI $azImdsUri -Method get).compute.resourceGroupName
$hostName = $env:COMPUTERNAME

$fileVersion = [System.Diagnostics.FileVersionInfo]::GetVersionInfo("C:\Windows\System32\crypt32.dll").FileVersionRaw.ToString()
Write-Host "File Version:" $fileVersion

$fileHash = (Get-FileHash -Path $crypt32Path).Hash
Write-Host "File Hash: " $fileHash

$currentBuild = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion").CurrentBuildNumber
$currentUBR = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion").UBR
Write-Host "Current OS Build: " ($currentBuild + "." + $currentUBR)

$currentOsVersion = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion").ReleaseID
Write-Host "Current OS Version: " $currentOsVersion


$result = $fileVersion -eq $validFileVesion -and `
          $fileHash -eq $validHash -and `
          $osBuild -eq ($currentBuild + "." + $currentUBR) -and `
          $currentOsVersion -eq $osVersion

if ($result -eq $true) {
    Write-Host -ForegroundColor Green "[-] Your virtual machine has applied the patch"
    Write-Host -ForegroundColor DarkYellow "`t [-] Virtual Machine name: " $vmName
    Write-Host -ForegroundColor DarkYellow "`t [-] Virtual Machine RG name: " $rgName
    Write-Host -ForegroundColor DarkYellow "`t [-] Host name: " $hostName
}
elseif ($result -ne $true) {
    Write-Host -ForegroundColor Yellow "[!] Please verify again!"
    Write-Host -ForegroundColor DarkYellow "`t [-] Virtual Machine name: " $vmName
    Write-Host -ForegroundColor DarkYellow "`t [-] Virtual Machine RG name: " $rgName
    Write-Host -ForegroundColor DarkYellow "`t [-] Host name: " $hostName
}